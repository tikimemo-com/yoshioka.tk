<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ - ã¡ã‚­ãƒ¡ãƒ¢</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet" />
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
  <script src="script.js" defer></script>
</head>
<body class="dashboard-page">
  <header class="header">
    <div class="header-content">
      <a href="dashboard.html" class="logo">ğŸš¨ ThikiMemo</a>
      <nav class="nav-menu">
        <a href="dashboard.html" class="nav-item">ãƒãƒƒãƒ—</a>
        <a href="dashboard.html#recent-reports" class="nav-item">æŠ•ç¨¿ä¸€è¦§</a>
        <a href="dashboard.html#stats" class="nav-item">çµ±è¨ˆ</a>
        <a href="dashboard.html#settings" class="nav-item">è¨­å®š</a>
      </nav>
      <button id="logout-button" style="display:none;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
  </header>

  <main class="main-container">
    <section class="hero-section">
      <h1 class="hero-title">åœ°åŸŸã®å®‰å…¨ã‚’å®ˆã‚‹</h1>
      <p class="hero-subtitle">
        ã‚ãªãŸã®è¡—ã®å±é™ºæƒ…å ±ã‚’ã¿ã‚“ãªã§å…±æœ‰ã—ã€<br />
        ã‚ˆã‚Šå®‰å…¨ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’ä½œã‚Šã¾ã—ã‚‡ã†
      </p>
      <div class="cta-buttons">
        <a href="report.html" class="cta-button">ğŸ“ å±é™ºã‚’å ±å‘Š</a>
        <a href="#" class="cta-button secondary" onclick="viewMap()">ğŸ—ºï¸ ãƒãƒƒãƒ—ã‚’è¦‹ã‚‹</a>
      </div>
    </section>

    <section id="stats" class="stats-bar">
      <div class="stat-item">
        <div class="stat-number" id="totalReports">0</div>
        <div class="stat-label">ç·æŠ•ç¨¿æ•°</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="thisWeek">0</div>
        <div class="stat-label">ä»Šé€±ã®æŠ•ç¨¿</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="activeUsers">0</div>
        <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="resolvedIssues">0</div>
        <div class="stat-label">è§£æ±ºæ¸ˆã¿</div>
      </div>
    </section>

    <section id="recent-reports" class="recent-reports">
      <h2 class="section-title">æœ€æ–°ã®å ±å‘Š</h2>
      <div class="recent-list" id="reports-list">
        <!-- æŠ•ç¨¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
    </section>
  </main>

  <script>
    // æœ€æ–°æŠ•ç¨¿ã‚’Firestoreã‹ã‚‰èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    document.addEventListener('DOMContentLoaded', async () => {
      if (!firebase.auth().currentUser) return;

      const reportsList = document.getElementById('reports-list');
      const db = firebase.firestore();

      try {
        const snapshot = await db.collection('reports').orderBy('timestamp', 'desc').limit(10).get();
        if (reportsList) {
          reportsList.innerHTML = '';
          snapshot.forEach(doc => {
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'recent-item';
            div.innerHTML = `
              <div class="recent-icon">${getIconByType(data.type)}</div>
              <div class="recent-content">
                <div class="recent-title">${escapeHTML(data.title)}</div>
                <div class="recent-details">
                  <div class="recent-location">ğŸ“ ${escapeHTML(data.location)}</div>
                  <div class="recent-time">â° ${formatTimestamp(data.timestamp)}</div>
                </div>
              </div>
            `;
            reportsList.appendChild(div);
          });
        }
      } catch (e) {
        console.error('æŠ•ç¨¿å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    });

    function getIconByType(type) {
      switch (type) {
        case 'traffic': return 'ğŸš—';
        case 'disaster': return 'âš ï¸';
        case 'crime': return 'ğŸ”';
        case 'infrastructure': return 'ğŸ—ï¸';
        default: return 'â“';
      }
    }

    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, c => ({
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
      })[c]);
    }

    function formatTimestamp(timestamp) {
      if (!timestamp || !timestamp.toDate) return '';
      const date = timestamp.toDate();
      const now = new Date();
      const diffMs = now - date;
      if (diffMs < 60000) return 'ãŸã£ãŸä»Š';
      if (diffMs < 3600000) return `${Math.floor(diffMs/60000)}åˆ†å‰`;
      if (diffMs < 86400000) return `${Math.floor(diffMs/3600000)}æ™‚é–“å‰`;
      return date.toLocaleDateString();
    }
  </script>
</body>
</html>
